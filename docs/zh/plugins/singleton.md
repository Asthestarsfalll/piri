# Singleton 插件

Singleton 插件管理单例窗口——只应该有一个实例的窗口。当你切换一个单例时，如果窗口已经存在，它会聚焦该窗口；否则，它会启动应用程序。这对于浏览器、终端或其他通常只需要一个实例运行的工具非常有用。

## 配置

在配置文件中添加 `[singleton.{name}]` 节来配置单例。每个单例需要一个唯一的名称。

### 配置示例

```toml
[piri.plugins]
singleton = true

[singleton.browser]
command = "google-chrome-stable"

[singleton.term]
command = "GTK_IM_MODULE=wayland ghostty --class=singleton.term"
app_id = "singleton.term"
```

### 配置参数说明

- `command` (必需): 启动应用程序的完整命令字符串，可以包含环境变量和参数

- `app_id` (可选): 用于匹配窗口的应用 ID。如果不指定，插件会自动从命令中提取 app_id，方法是取可执行文件名（例如，从 "/usr/bin/google-chrome-stable" 或 "google-chrome-stable --some-arg" 中提取 "google-chrome-stable"）

## 使用方法

### 切换单例

```bash
piri singleton {name} toggle
```

例如：

```bash
# 切换浏览器单例
piri singleton browser toggle

# 切换终端单例
piri singleton term toggle
```

## 工作原理

1. **首次切换**: 当首次执行 `piri singleton {name} toggle` 时，插件会：
   - 检查是否已存在匹配模式的窗口
   - 如果找到，聚焦它并注册窗口 ID
   - 如果未找到，使用配置的命令启动应用程序
   - 等待窗口出现（最多 5 秒）
   - 窗口出现后，聚焦它并注册窗口 ID

2. **后续切换**: 
   - 如果注册的窗口仍然存在，立即聚焦它
   - 如果窗口已关闭，从注册表中移除它，并搜索匹配模式的现有窗口
   - 如果未找到匹配的窗口，再次启动应用程序

3. **窗口匹配**: 
   - 如果配置中指定了 `app_id`，则使用它
   - 否则，自动从命令中提取 app_id（不带路径的可执行文件名）
   - 通过窗口的 `app_id` 属性匹配窗口

## 特性

- ✅ **智能窗口检测**: 在启动新实例之前自动检测现有窗口
- ✅ **自动 App ID 提取**: 如果未指定 `app_id`，自动从命令中提取
- ✅ **窗口注册表**: 通过 ID 跟踪单例窗口，实现快速查找
- ✅ **焦点管理**: 自动聚焦现有窗口，而不是创建重复实例
- ✅ **健壮的窗口匹配**: 使用模式匹配来查找窗口，即使它们不是由插件启动的

## 使用场景

- **浏览器管理**: 确保一次只打开一个浏览器窗口
- **终端管理**: 通过切换保持单个终端实例可访问
- **应用程序启动器**: 快速访问常用应用程序，并保证单实例
- **资源管理**: 防止资源密集型应用程序的多个实例

## 注意事项

1. **窗口匹配**: 插件使用 `app_id` 来匹配窗口。确保你的应用程序设置了正确的 `app_id` 属性，或在配置中明确指定
2. **命令提取**: 如果未指定 `app_id`，插件会通过以下方式从命令中提取：
   - 取第一个单词（任何空白字符之前）
   - 移除路径（仅取可执行文件名）
   - 例如："/usr/bin/google-chrome-stable" → "google-chrome-stable"
3. **窗口注册**: 插件通过 ID 维护单例窗口的注册表。如果窗口被外部关闭，插件会在下次切换时检测到并将其从注册表中移除
4. **超时**: 插件在启动应用程序后最多等待 5 秒（50 次尝试 × 100ms）让窗口出现。如果在此时间内没有窗口出现，切换操作会完成但不会报错，但不会聚焦任何窗口

